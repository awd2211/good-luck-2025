# ğŸ”¥ çƒ­æ›´æ–°é…ç½®æŒ‡å—

## æ¦‚è¿°

é¡¹ç›®å·²é…ç½®æœ€ä¼˜çš„çƒ­æ›´æ–°æ–¹æ¡ˆï¼š
- **å¼€å‘ç¯å¢ƒ**: tsx (æé€Ÿé‡å¯ï¼Œ3-10å€å¿«äºnodemon)
- **ç”Ÿäº§ç¯å¢ƒ**: PM2 clusteræ¨¡å¼ (é›¶åœæœºé‡è½½)

---

## ğŸš€ å¼€å‘ç¯å¢ƒ - tsx

### åŸºæœ¬ä½¿ç”¨

```bash
# æ ‡å‡†å¼€å‘æ¨¡å¼ï¼ˆæ¨èï¼‰
npm run dev

# å¸¦è°ƒè¯•å™¨çš„å¼€å‘æ¨¡å¼
npm run dev:inspect

# å›é€€åˆ°æ—§çš„nodemonæ¨¡å¼
npm run dev:old
```

### tsx ä¼˜åŠ¿

âœ… **æé€Ÿé‡å¯**: æ¯”nodemonå¿«3-10å€
âœ… **ä½å†…å­˜å ç”¨**: ä½¿ç”¨esbuildï¼Œè½»é‡é«˜æ•ˆ
âœ… **é›¶é…ç½®**: å¼€ç®±å³ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®
âœ… **TypeScriptåŸç”Ÿæ”¯æŒ**: æ— éœ€ts-node
âœ… **æ™ºèƒ½ç›‘å¬**: è‡ªåŠ¨å¿½ç•¥node_modulesç­‰ç›®å½•

### æµ‹è¯•çƒ­æ›´æ–°

1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š
   ```bash
   cd /home/eric/good-luck-2025/backend
   npm run dev
   ```

2. ä¿®æ”¹ä»»æ„æ–‡ä»¶ï¼ˆå¦‚ `src/index.ts`ï¼‰ï¼Œä¿å­˜åç«‹å³ç”Ÿæ•ˆ

3. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š
   ```
   [tsx] rebuilding...
   ğŸš€ åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:50301
   ```

### tsx vs nodemon æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | tsx | nodemon + ts-node |
|------|-----|-------------------|
| é¦–æ¬¡å¯åŠ¨ | ~500ms | ~2s |
| çƒ­é‡è½½é€Ÿåº¦ | ~200ms | ~1.5s |
| å†…å­˜å ç”¨ | ~80MB | ~150MB |
| TypeScriptæ”¯æŒ | åŸç”Ÿ | éœ€è¦ts-node |

---

## ğŸ­ ç”Ÿäº§ç¯å¢ƒ - PM2

### åŸºæœ¬ä½¿ç”¨

```bash
# é¦–æ¬¡å¯åŠ¨ï¼ˆè‡ªåŠ¨ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒï¼‰
npm run pm2:start

# é›¶åœæœºé‡è½½ï¼ˆä»£ç æ›´æ–°åï¼‰
npm run pm2:reload

# æŸ¥çœ‹æ—¥å¿—
npm run pm2:logs

# åœæ­¢æœåŠ¡
npm run pm2:stop
```

### PM2 Clusteræ¨¡å¼ç‰¹æ€§

âœ… **é›¶åœæœºéƒ¨ç½²**: reloadå‘½ä»¤é€ä¸ªé‡å¯è¿›ç¨‹
âœ… **è´Ÿè½½å‡è¡¡**: è‡ªåŠ¨åˆ†é…è¯·æ±‚åˆ°å¤šä¸ªè¿›ç¨‹
âœ… **è‡ªåŠ¨é‡å¯**: å´©æºƒåè‡ªåŠ¨æ¢å¤
âœ… **å†…å­˜é™åˆ¶**: è¶…è¿‡500MBè‡ªåŠ¨é‡å¯
âœ… **æ—¥å¿—ç®¡ç†**: JSONæ ¼å¼ï¼Œä¾¿äºåˆ†æ

### éƒ¨ç½²æµç¨‹

```bash
# 1. æ„å»ºç”Ÿäº§ä»£ç 
npm run build

# 2. é¦–æ¬¡éƒ¨ç½²
npm run pm2:start

# 3. åç»­æ›´æ–°ï¼ˆé›¶åœæœºï¼‰
git pull
npm install
npm run build
npm run pm2:reload  # å…³é”®ï¼šä½¿ç”¨reloadè€Œérestart
```

### PM2 é…ç½®è¯´æ˜

**ecosystem.config.js å…³é”®é…ç½®ï¼š**

```javascript
{
  instances: 'max',        // ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒï¼ˆæˆ–è®¾ç½®ä¸ºå…·ä½“æ•°å­—å¦‚2ï¼‰
  exec_mode: 'cluster',    // é›†ç¾¤æ¨¡å¼ï¼Œæ”¯æŒè´Ÿè½½å‡è¡¡
  max_memory_restart: '500M',  // å†…å­˜é™åˆ¶
  kill_timeout: 5000,      // ä¼˜é›…å…³é—­è¶…æ—¶
  listen_timeout: 3000,    // æ–°è¿›ç¨‹å¯åŠ¨è¶…æ—¶
}
```

### PM2 å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 list

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 show fortune-backend

# å®æ—¶ç›‘æ§
pm2 monit

# æŸ¥çœ‹æ—¥å¿—
pm2 logs fortune-backend --lines 100

# æ¸…ç©ºæ—¥å¿—
pm2 flush

# é‡å¯æ‰€æœ‰è¿›ç¨‹
pm2 restart all

# åˆ é™¤è¿›ç¨‹
pm2 delete fortune-backend

# ä¿å­˜è¿›ç¨‹åˆ—è¡¨ï¼ˆå¼€æœºè‡ªå¯ï¼‰
pm2 save
pm2 startup
```

---

## ğŸ”§ é«˜çº§é…ç½®

### ä¿®æ”¹å®ä¾‹æ•°é‡

å¦‚æœCPUæ ¸å¿ƒè¾ƒå¤šï¼Œå¯ä»¥é™åˆ¶å®ä¾‹æ•°é‡ï¼š

```javascript
// ecosystem.config.js
instances: 2,  // æ”¹ä¸ºå…·ä½“æ•°å­—
```

### å¯ç”¨å¼€å‘ç¯å¢ƒwatchæ¨¡å¼

PM2ä¹Ÿæ”¯æŒwatchæ¨¡å¼ï¼ˆä½†å¼€å‘ç¯å¢ƒæ¨èç”¨tsxï¼‰ï¼š

```bash
pm2 start ecosystem.config.js --watch --env development
```

### å¤šç¯å¢ƒé…ç½®

```bash
# å¼€å‘ç¯å¢ƒï¼ˆç«¯å£3000ï¼‰
pm2 start ecosystem.config.js --env development

# ç”Ÿäº§ç¯å¢ƒï¼ˆç«¯å£60301ï¼‰
pm2 start ecosystem.config.js --env production
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### tsxç›¸å…³

**é—®é¢˜**: tsx watchæœªæ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–
**è§£å†³**: æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ”¯æŒinotifyï¼ˆLinuxï¼‰

**é—®é¢˜**: çƒ­é‡è½½åè¿›ç¨‹æœªå®Œå…¨å…³é—­
**è§£å†³**: æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦æœ‰æœªé‡Šæ”¾çš„èµ„æºï¼ˆæ•°æ®åº“è¿æ¥ã€å®šæ—¶å™¨ç­‰ï¼‰

### PM2ç›¸å…³

**é—®é¢˜**: reloadåæœåŠ¡ä¸å¯ç”¨
**è§£å†³**:
```bash
# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
pm2 list

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs fortune-backend --err --lines 50

# æ‰‹åŠ¨é‡å¯
pm2 restart fortune-backend
```

**é—®é¢˜**: å†…å­˜æŒç»­å¢é•¿
**è§£å†³**: æ£€æŸ¥ä»£ç æ˜¯å¦æœ‰å†…å­˜æ³„æ¼ï¼Œè°ƒä½`max_memory_restart`

**é—®é¢˜**: ç«¯å£è¢«å ç”¨
**è§£å†³**:
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -ti:60301

# æ€æ­»è¿›ç¨‹
lsof -ti:60301 | xargs kill -9

# é‡æ–°å¯åŠ¨
npm run pm2:start
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å¼€å‘ç¯å¢ƒ
1. ä½¿ç”¨ `tsx watch` è€Œé `nodemon`ï¼ˆå·²é…ç½®ï¼‰
2. é¿å…ç›‘å¬å¤§é‡ä¸å¿…è¦çš„æ–‡ä»¶
3. ä½¿ç”¨ `--inspect` è¿›è¡Œè°ƒè¯•è€Œéconsole.log

### ç”Ÿäº§ç¯å¢ƒ
1. ä½¿ç”¨ `pm2 reload` è€Œé `pm2 restart`
2. æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´å®ä¾‹æ•°é‡
3. å®šæœŸæ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°ï¼ˆ`pm2 flush`ï¼‰
4. é…ç½®nginxåå‘ä»£ç†å®ç°æ›´é«˜çº§çš„è´Ÿè½½å‡è¡¡

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [tsxå®˜æ–¹æ–‡æ¡£](https://github.com/privatenumber/tsx)
- [PM2å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/)
- [PM2 Clusteræ¨¡å¼](https://pm2.keymetrics.io/docs/usage/cluster-mode/)
- [Node.jsä¼˜é›…å…³é—­](https://github.com/godaddy/terminus)

---

## ğŸ¯ å¿«é€Ÿå‚è€ƒ

| åœºæ™¯ | å‘½ä»¤ |
|------|------|
| å¼€å‘è°ƒè¯• | `npm run dev` |
| å¼€å‘+æ–­ç‚¹è°ƒè¯• | `npm run dev:inspect` |
| ç”Ÿäº§é¦–æ¬¡éƒ¨ç½² | `npm run build && npm run pm2:start` |
| ç”Ÿäº§æ›´æ–°éƒ¨ç½² | `npm run build && npm run pm2:reload` |
| æŸ¥çœ‹æ—¥å¿— | `npm run pm2:logs` |
| åœæ­¢æœåŠ¡ | `npm run pm2:stop` |

---

**æœ€åæ›´æ–°**: 2025-11-15
**ä½œè€…**: Claude Code
**ç‰ˆæœ¬**: 1.0
