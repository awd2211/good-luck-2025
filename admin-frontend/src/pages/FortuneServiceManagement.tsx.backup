import { useState, useEffect } from 'react'
import { Card, Table, Button, Space, Tag, Modal, Form, Input, InputNumber, Select, Switch, message, Tabs } from 'antd'
import { PlusOutlined, EditOutlined, DeleteOutlined, EyeOutlined } from '@ant-design/icons'
import type { ColumnsType } from 'antd/es/table'
import api from '../services/apiService'

const { TextArea } = Input
const { Option } = Select
const { TabPane } = Tabs

interface Category {
  id: number
  name: string
  code: string
  icon: string
  description: string
  status: string
}

interface FortuneService {
  id: number
  category_id: number
  category_name: string
  name: string
  code: string
  subtitle: string
  original_price: number
  current_price: number
  vip_price: number
  status: string
  is_hot: boolean
  is_new: boolean
  is_recommended: boolean
  view_count: number
  order_count: number
  rating: number
  created_at: string
}

const FortuneServiceManagement = () => {
  const [categories, setCategories] = useState<Category[]>([])
  const [services, setServices] = useState<FortuneService[]>([])
  const [loading, setLoading] = useState(false)
  const [modalVisible, setModalVisible] = useState(false)
  const [editingService, setEditingService] = useState<FortuneService | null>(null)
  const [form] = Form.useForm()
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 20,
    total: 0
  })

  // 获取分类列表
  const fetchCategories = async () => {
    try {
      const res = await api.get('/fortune-categories')
      if (res.data.success) {
        const categoriesData = res.data.data
        if (Array.isArray(categoriesData)) {
          setCategories(categoriesData)
        } else if (categoriesData && Array.isArray(categoriesData.list)) {
          setCategories(categoriesData.list)
        } else {
          setCategories([])
        }
      }
    } catch (error: any) {
      message.error(error.response?.data?.message || '获取分类失败')
      setCategories([])
    }
  }

  // 获取服务列表
  const fetchServices = async (page = pagination.current, pageSize = pagination.pageSize) => {
    setLoading(true)
    try {
      const res = await api.get('/fortune-services', {
        params: { page, limit: pageSize }
      })
      if (res.data.success) {
        const servicesData = res.data.data
        if (Array.isArray(servicesData)) {
          setServices(servicesData)
          setPagination({
            current: page,
            pageSize,
            total: servicesData.length
          })
        } else if (servicesData && Array.isArray(servicesData.list)) {
          setServices(servicesData.list)
          setPagination({
            current: page,
            pageSize,
            total: servicesData.pagination?.total || servicesData.list.length
          })
        } else {
          setServices([])
          setPagination({ current: page, pageSize, total: 0 })
        }
      }
    } catch (error: any) {
      message.error(error.response?.data?.message || '获取服务列表失败')
      setServices([])
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchCategories()
    fetchServices()
  }, [])

  // 打开创建/编辑弹窗
  const handleOpenModal = (service?: FortuneService) => {
    if (service) {
      setEditingService(service)
      form.setFieldsValue(service)
    } else {
      setEditingService(null)
      form.resetFields()
    }
    setModalVisible(true)
  }

  // 提交表单
  const handleSubmit = async () => {
    try {
      const values = await form.validateFields()

      if (editingService) {
        // 更新
        await api.put(`/fortune-services/${editingService.id}`, values)
        message.success('更新成功')
      } else {
        // 创建
        await api.post('/fortune-services', values)
        message.success('创建成功')
      }

      setModalVisible(false)
      fetchServices()
    } catch (error: any) {
      message.error(error.response?.data?.message || '操作失败')
    }
  }

  // 删除服务
  const handleDelete = (id: number) => {
    Modal.confirm({
      title: '确认删除',
      content: '确定要删除这个服务吗？',
      onOk: async () => {
        try {
          await api.delete(`/fortune-services/${id}`)
          message.success('删除成功')
          fetchServices()
        } catch (error: any) {
          message.error(error.response?.data?.message || '删除失败')
        }
      }
    })
  }

  // 更新状态
  const handleUpdateStatus = async (id: number, status: string) => {
    try {
      await api.put(`/fortune-services/${id}`, { status })
      message.success('状态更新成功')
      fetchServices()
    } catch (error: any) {
      message.error(error.response?.data?.message || '状态更新失败')
    }
  }

  const columns: ColumnsType<FortuneService> = [
    {
      title: 'ID',
      dataIndex: 'id',
      key: 'id',
      width: 60
    },
    {
      title: '服务名称',
      dataIndex: 'name',
      key: 'name',
      width: 200
    },
    {
      title: '分类',
      dataIndex: 'category_name',
      key: 'category_name',
      width: 100,
      render: (text) => <Tag color="blue">{text}</Tag>
    },
    {
      title: '价格',
      key: 'price',
      width: 150,
      render: (_, record) => (
        <Space direction="vertical" size="small">
          <span>原价: ¥{record.original_price}</span>
          <span style={{ color: '#f5222d', fontWeight: 'bold' }}>现价: ¥{record.current_price}</span>
          {record.vip_price && <span style={{ color: '#faad14' }}>VIP: ¥{record.vip_price}</span>}
        </Space>
      )
    },
    {
      title: '标签',
      key: 'tags',
      width: 120,
      render: (_, record) => (
        <Space>
          {record.is_hot && <Tag color="red">热门</Tag>}
          {record.is_new && <Tag color="green">新品</Tag>}
          {record.is_recommended && <Tag color="gold">推荐</Tag>}
        </Space>
      )
    },
    {
      title: '统计',
      key: 'stats',
      width: 150,
      render: (_, record) => (
        <Space direction="vertical" size="small">
          <span>浏览: {record.view_count}</span>
          <span>订单: {record.order_count}</span>
          <span>评分: {record.rating ? Number(record.rating).toFixed(1) : '0.0'}</span>
        </Space>
      )
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      width: 100,
      render: (status, record) => (
        <Select
          value={status}
          style={{ width: '100%' }}
          onChange={(value) => handleUpdateStatus(record.id, value)}
        >
          <Option value="draft">草稿</Option>
          <Option value="active">上架</Option>
          <Option value="inactive">下架</Option>
        </Select>
      )
    },
    {
      title: '操作',
      key: 'action',
      width: 180,
      fixed: 'right',
      render: (_, record) => (
        <Space size="small">
          <Button type="link" size="small" icon={<EyeOutlined />}>详情</Button>
          <Button
            type="link"
            size="small"
            icon={<EditOutlined />}
            onClick={() => handleOpenModal(record)}
          >
            编辑
          </Button>
          <Button
            type="link"
            size="small"
            danger
            icon={<DeleteOutlined />}
            onClick={() => handleDelete(record.id)}
          >
            删除
          </Button>
        </Space>
      )
    }
  ]

  return (
    <div>
      <Card
        title="算命服务管理"
        extra={
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => handleOpenModal()}
          >
            创建服务
          </Button>
        }
      >
        <Table
          columns={columns}
          dataSource={services}
          rowKey="id"
          loading={loading}
          scroll={{ x: 1400 }}
          pagination={{
            current: pagination.current,
            pageSize: pagination.pageSize,
            total: pagination.total,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total) => `共 ${total} 条记录`,
            onChange: (page, pageSize) => {
              fetchServices(page, pageSize)
            },
            onShowSizeChange: (current, size) => {
              fetchServices(1, size)
            }
          }}
        />
      </Card>

      {/* 创建/编辑弹窗 */}
      <Modal
        title={editingService ? '编辑服务' : '创建服务'}
        open={modalVisible}
        onOk={handleSubmit}
        onCancel={() => setModalVisible(false)}
        width={800}
      >
        <Form form={form} layout="vertical">
          <Form.Item
            name="category_id"
            label="服务分类"
            rules={[{ required: true, message: '请选择分类' }]}
          >
            <Select placeholder="请选择分类">
              {categories.map(cat => (
                <Option key={cat.id} value={cat.id}>
                  {cat.icon} {cat.name}
                </Option>
              ))}
            </Select>
          </Form.Item>

          <Form.Item
            name="name"
            label="服务名称"
            rules={[{ required: true, message: '请输入服务名称' }]}
          >
            <Input placeholder="请输入服务名称" />
          </Form.Item>

          <Form.Item
            name="code"
            label="服务代码"
            rules={[{ required: true, message: '请输入服务代码' }]}
          >
            <Input placeholder="请输入唯一的服务代码" />
          </Form.Item>

          <Form.Item name="subtitle" label="副标题">
            <Input placeholder="请输入副标题" />
          </Form.Item>

          <Form.Item name="description" label="简介">
            <TextArea rows={3} placeholder="请输入服务简介" />
          </Form.Item>

          <Space style={{ width: '100%' }}>
            <Form.Item
              name="original_price"
              label="原价"
              rules={[{ required: true, message: '请输入原价' }]}
            >
              <InputNumber min={0} step={0.1} style={{ width: 150 }} />
            </Form.Item>

            <Form.Item
              name="current_price"
              label="现价"
              rules={[{ required: true, message: '请输入现价' }]}
            >
              <InputNumber min={0} step={0.1} style={{ width: 150 }} />
            </Form.Item>

            <Form.Item name="vip_price" label="VIP价格">
              <InputNumber min={0} step={0.1} style={{ width: 150 }} />
            </Form.Item>
          </Space>

          <Space>
            <Form.Item name="is_hot" label="热门推荐" valuePropName="checked">
              <Switch />
            </Form.Item>

            <Form.Item name="is_new" label="新品标签" valuePropName="checked">
              <Switch />
            </Form.Item>

            <Form.Item name="is_recommended" label="首页推荐" valuePropName="checked">
              <Switch />
            </Form.Item>
          </Space>

          <Form.Item name="status" label="状态" initialValue="draft">
            <Select>
              <Option value="draft">草稿</Option>
              <Option value="active">上架</Option>
              <Option value="inactive">下架</Option>
            </Select>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  )
}

export default FortuneServiceManagement
